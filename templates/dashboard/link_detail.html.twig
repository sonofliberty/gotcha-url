{% extends 'base.html.twig' %}

{% block title %}Link Details - Gotcha URL{% endblock %}

{% block body %}
<div class="mb-4">
    <div class="d-flex align-items-center mb-1">
        <a href="{{ path('app_dashboard') }}" class="btn btn-sm btn-outline-secondary me-3">&larr; Back</a>
        <h4 class="mb-0">
            <code>{{ url('app_track', {slug: link.slug}) }}</code>
            <button type="button" class="btn btn-sm btn-outline-secondary btn-copy ms-1"
                    data-url="{{ url('app_track', {slug: link.slug}) }}">Copy</button>
        </h4>
    </div>
    <div class="ms-5 ps-3">
        <span class="label-display me-2" data-link-id="{{ link.id }}" data-label="{{ link.label ?? '' }}">
            {% if link.label %}
                {{ link.label }}
            {% else %}
                <span class="text-muted fst-italic">+ Add label</span>
            {% endif %}
        </span>
        <span class="text-muted small" title="{{ link.targetUrl }}">
            &rarr; <a href="{{ link.targetUrl }}" target="_blank" class="text-muted">{{ link.targetUrl|length > 80 ? link.targetUrl[:80] ~ '...' : link.targetUrl }}</a>
        </span>
        <span class="text-muted small ms-3">Created {{ link.createdAt|date('M j, Y') }}</span>
        <span class="badge bg-info ms-2">{{ link.visitCount }} {{ link.visitCount == 1 ? 'visit' : 'visits' }}</span>
    </div>
</div>

{% if visits|length == 0 %}
    <div class="text-center py-5 text-muted">
        <p class="mb-1 fw-medium">No visits yet</p>
        <p class="small">Share your link to start tracking visits.</p>
    </div>
{% else %}
    <div class="table-responsive">
        <table class="table table-hover table-sm align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>When</th>
                    <th>IP Address</th>
                    <th>Location</th>
                    <th>Referrer</th>
                    <th>Platform</th>
                </tr>
            </thead>
            <tbody>
                {% for visit in visits %}
                    <tr style="cursor:pointer" onclick="window.location='{{ path('app_visit_detail', {id: visit.id}) }}'">
                        <td class="text-nowrap">
                            <time datetime="{{ visit.createdAt|date('c') }}">{{ visit.createdAt|date('M j, Y H:i') }}</time>
                        </td>
                        <td><code>{{ visit.ipAddress }}</code></td>
                        <td>
                            {% if visit.countryCode or visit.city %}
                                {{ visit.countryCode ?? '' }}{% if visit.countryCode and visit.city %}, {% endif %}{{ visit.city ?? '' }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if visit.referrer %}
                                <span title="{{ visit.referrer }}">{{ visit.referrer|split('/')[2] | default(visit.referrer) }}</span>
                            {% else %}
                                <span class="text-muted">Direct</span>
                            {% endif %}
                        </td>
                        <td>{{ visit.platform ?? '-' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if totalPages > 1 %}
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item {{ currentPage <= 1 ? 'disabled' }}">
                    <a class="page-link" href="{{ path('app_link_detail', {id: link.id, page: currentPage - 1}) }}">Previous</a>
                </li>
                {% for p in 1..totalPages %}
                    <li class="page-item {{ p == currentPage ? 'active' }}">
                        <a class="page-link" href="{{ path('app_link_detail', {id: link.id, page: p}) }}">{{ p }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {{ currentPage >= totalPages ? 'disabled' }}">
                    <a class="page-link" href="{{ path('app_link_detail', {id: link.id, page: currentPage + 1}) }}">Next</a>
                </li>
            </ul>
        </nav>
    {% endif %}
{% endif %}

<div class="border-top mt-4 pt-3 text-end">
    <form method="post" action="{{ path('app_delete_link', {id: link.id}) }}" class="d-inline"
          onsubmit="return confirm('Are you sure you want to delete this link and all its visit data?')">
        <input type="hidden" name="_method" value="DELETE">
        <button type="submit" class="btn btn-link text-danger small text-decoration-none">Delete this link</button>
    </form>
</div>
{% endblock %}

